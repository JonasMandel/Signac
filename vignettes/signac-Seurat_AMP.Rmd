---
title: 'Signac and Seurat: Analysis of kidney cells from AMP'
author: 'Mathew Chamberlain'
date: "`r Sys.Date()`"
output:
  html_document:
    fig_crop: no
    theme: sandstone
    toc: true
    includes:
      after_body: footer.html
---

This vignette shows how to use Signac with Seurat. There are three parts: Seurat, Signac and then MASC. We use an example set of kidney cells from AMP from [this publication](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6726437/).

## Load data

Read the CEL-seq2 data.

```{r read CELSeq2, message = F, eval = F}
ReadCelseq <- function (counts.file, meta.file)
{
  E = suppressWarnings(readr::read_tsv(counts.file));
  gns <- E$gene;
  E = E[,-1]
  M = suppressWarnings(readr::read_tsv(meta.file))
  S = lapply(unique(M$sample), function(x) {
    logik = colnames(E) %in% M$cell_name[M$sample == x]
    Matrix::Matrix(as.matrix(E[,logik]), sparse = TRUE)}
    )
  names(S) <- unique(M$sample)
  S = lapply(S, function(x){
    rownames(x) <- gns
    x
  })
  S
}

counts.file = "./SDY997_EXP15176_celseq_matrix_ru10_molecules.tsv.gz"
meta.file = "./SDY997_EXP15176_celseq_meta.tsv"

E = ReadCelseq(counts.file = counts.file, meta.file = meta.file)
M = suppressWarnings(readr::read_tsv(meta.file))
```

Merge into a single matrix

```{r filter celseq, message = F, eval = F}
# keep only kidney cells
E = lapply(E, function(x){
  x[,grepl("K", colnames(x))]
})

# remove any sample with no cells
E = E[sapply(E, ncol) > 0]

# merge into a single matrix
E = do.call(cbind, E)
```

## Seurat 

Start with the standard pre-processing steps for a Seurat object.

```{r setupSeurat, message = F, eval = F}
library(Seurat)
```

Create a Seurat object, and then perform SCTransform normalization. Note:

* You can use the legacy functions here (i.e., NormalizeData, ScaleData, etc.), use SCTransform or any other normalization method (including no normalization). We did not notice a significant difference in cell type annotations with different normalization methods.
* We think that it is best practice to use SCTransform, but it is not a necessary step. Signac will work fine without it.

```{r Seurat, message = T, eval = F}
# load data
kidney <- CreateSeuratObject(counts = E, project = "celseq")

# store mitochondrial percentage in object meta data
kidney <- PercentageFeatureSet(kidney, pattern = "^MT-", col.name = "percent.mt")

# run sctransform
kidney <- SCTransform(kidney,vars.to.regress = "percent.mt", verbose = FALSE)
```

Perform dimensionality reduction by PCA and UMAP embedding. Note:

* Signac actually needs these functions since it uses the nearest neighbor graph generated by Seurat.

```{r Seurat 2, message = T, eval = F}
# These are now standard steps in the Seurat workflow for visualization and clustering
kidney <- RunPCA(kidney, verbose = FALSE)
kidney <- RunUMAP(kidney, dims = 1:30, verbose = FALSE)
kidney <- FindNeighbors(kidney, dims = 1:30, verbose = FALSE)
```

## Signac

First, make sure that you have the Signac package installed.

```{r setup2, message = F, eval = F}
devtools::install_github("mathewchamberlain/Signac")
library(Signac)
```

Generate Signac labels for the Seurat object. Note:

* Optionally, you can do parallel computing by setting num.cores > 1 in the Signac function.
* Run time is ~10 minutes for ~10,000 cells on a single core.

```{r Signac, message = T, eval = F}
# Run Signac
data("training_HPCA")
labels <- Signac(kidney, R = training_HPCA)
celltypes = Generate_lbls(labels, E = kidney)
```

## Visualizations

Now we can visualize the cell type classifications at many different levels:

```{r Seurat Visualization 0, message = F}
kidney <- Seurat::AddMetaData(kidney, metadata=celltypes$Immune, col.name = "immmune")
kidney <- Seurat::SetIdent(kidney, value='immmune')
DimPlot(kidney)
```

```{r Seurat Visualization 1, message = F}
kidney <- Seurat::AddMetaData(kidney, metadata=celltypes$L2, col.name = "celltypes")
kidney <- Seurat::SetIdent(kidney, value='celltypes')
DimPlot(kidney)
```

```{r Seurat Visualization 2, message = F}
lbls = factor(celltypes$CellTypes)
levels(lbls) <- sort(unique(lbls))
kidney <- Seurat::AddMetaData(kidney, metadata=lbls, col.name = "celltypes")
kidney <- Seurat::SetIdent(kidney, value='celltypes')
DimPlot(kidney)
```

```{r Seurat Visualization 3, message = F}
lbls = factor(celltypes$CellStates)
levels(lbls) <- sort(unique(lbls))
kidney <- Seurat::AddMetaData(kidney, metadata=lbls, col.name = "celltypes")
kidney <- Seurat::SetIdent(kidney, value='celltypes')
DimPlot(kidney)
```

Identify IMAGES

```{r Seurat get IMAGES, message = F, eval = T}
# Downsample just the immune cells
kidney.small <- kidney[, !celltypes$CellStates %in% c("NonImmune", "Fibroblasts", "Unclassified", "Endothelial", "Epithelial")]

# Find protein markers for all clusters, and draw a heatmap
markers <- FindAllMarkers(kidney.small, only.pos = TRUE, verbose = F, logfc.threshold = 1)
top10 <- markers %>%  group_by(cluster) %>% top_n(n = 3, wt = avg_logFC)
DoHeatmap(kidney.small, features = unique(top10$gene), angle = 90)
```

## Run MASC

```{r MASC, message = F, eval = F}
Meta_mapped = M[match(colnames(kidney), M$cell_name), ]
Meta_mapped$CellStates = celltypes$CellStates
Meta_mapped$disease = factor(Meta_mapped$disease)
Q = MASC(dataset = Meta_mapped, cluster = Meta_mapped$CellStates, contrast = 'disease', random_effects = c("plate", "lane", "sample"), verbose = F)
```

MASC results reveals that macrophages, plasma cells and CD8 central memory T cells are enriched (p value < 0.05) for disease.

```{r, results='asis'}
writeLines("td, th { padding : 6px } th { background-color : brown ; color : white; border : 1px solid white; } td { color : brown ; border : 1px solid brown }", con = "mystyle.css")
knitr::kable(Q, format = "html")
```

Save results

```{r save results, message = F, eval = F}
saveRDS(kidney, file = "kidney_signac.rds")
saveRDS(Q, file = "MASC_result.rds")
```

## Session information

```{r sessioninfo, message = F, echo = F}
sessionInfo()
```
