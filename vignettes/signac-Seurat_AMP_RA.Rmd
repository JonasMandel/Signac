---
title: 'Benchmarking Signac and SingleR with synovial flow cytometry data'
author: 'Mathew Chamberlain'
date: "`r Sys.Date()`"
output:
  html_document:
    fig_crop: no
    theme: cerulean
    toc: true
    includes:
      after_body: footer.html
---

This vignette shows how to use Signac to annotate flow-sorted synovial cells by integrating Signac with Seurat. We start with raw counts. 

## Load data

Read the CEL-seq2 data.

```{r read CELSeq2, message = F, eval = F}
ReadCelseq <- function (counts.file, meta.file)
{
  E = suppressWarnings(readr::read_tsv(counts.file));
  gns <- E$gene;
  E = E[,-1]
  E = Matrix::Matrix(as.matrix(E), sparse = TRUE)
  rownames(E) <- gns
  E
}

counts.file = "./celseq_matrix_ru10_molecules.tsv.gz"
meta.file = "./celseq_meta.immport.723957.tsv"

E = ReadCelseq(counts.file = counts.file, meta.file = meta.file)
M = suppressWarnings(readr::read_tsv(meta.file))

# filter data based on depth and number of genes detected
kmu = Matrix::colSums(E != 0)
kmu2 = Matrix::colSums(E)
E = E[,kmu > 200 & kmu2 > 500]

# filter by mitochondrial percentage
logik = grepl("^MT-", rownames(E))
MitoFrac = Matrix::colSums(E[logik,]) / Matrix::colSums(E) * 100
E = E[,MitoFrac < 20]
```

Run SingleR

```{r filter celseq, message = F, eval = F}
library(SingleR)
data("hpca")
Q = SingleR(sc_data = E, ref_data = hpca$data, types = hpca$main_types, fine.tune = F, numCores = 16)
save(file = "SingleR_Results.rda", Q)
True_labels = M$type[match(colnames(E), M$cell_name)]
```

Inspect SingleR labels compared to FACs

```{r Seurat Visualization 10, message = F, echo = F}
writeLines("td, th { padding : 6px } th { background-color : brown ; color : white; border : 1px solid white; } td { color : brown ; border : 1px solid brown }", con = "mystyle.css")
knitr::kable(table(True_labels, SingleR = Q$labels), format = "html")
```

## Signac 

Start with the standard pre-processing steps for a Seurat object.

```{r setupSeurat, message = F, eval = F}
library(Seurat)
```

Create a Seurat object, and then perform SCTransform normalization. Note:

* You can use the legacy functions here (i.e., NormalizeData, ScaleData, etc.), use SCTransform or any other normalization method (including no normalization). We did not notice a significant difference in cell type annotations with different normalization methods.
* We think that it is best practice to use SCTransform, but it is not a necessary step. Signac will work fine without it.

```{r Seurat, message = T, eval = F}
# load data
synovium <- CreateSeuratObject(counts = E, project = "FACs")

# run sctransform
synovium <- SCTransform(synovium, verbose = F)
```

Perform dimensionality reduction by PCA and UMAP embedding. Note:

* Signac actually needs these functions since it uses the nearest neighbor graph generated by Seurat.

```{r Seurat 2, message = T, eval = F}
# These are now standard steps in the Seurat workflow for visualization and clustering
synovium <- RunPCA(synovium, verbose = FALSE)
synovium <- RunUMAP(synovium, dims = 1:30, verbose = FALSE)
synovium <- FindNeighbors(synovium, dims = 1:30, verbose = FALSE)
```

## Signac

First, make sure that you have the Signac package installed.

```{r setup2, message = F, eval = F}
devtools::install_github("mathewchamberlain/Signac")
library(Signac)
```

Generate Signac labels for the Seurat object. Note:

* Optionally, you can do parallel computing by setting num.cores > 1 in the Signac function.
* Run time is ~10 minutes for ~10,000 cells on a single core.

```{r Signac, message = T, eval = F}
# Run Signac
data("training_HPCA")
labels <- Signac(synovium, R = training_HPCA)
celltypes = Generate_lbls(labels, E = synovium)
```

## Visualizations

Visualize the cell type classifications from Signac

```{r Seurat Visualization 2, message = F}
lbls = factor(celltypes$CellTypes)
levels(lbls) <- sort(unique(lbls))
synovium <- Seurat::AddMetaData(synovium, metadata=lbls, col.name = "celltypes")
synovium <- Seurat::SetIdent(synovium, value='celltypes')
DimPlot(synovium)
```

Compare Signac with FACs labels

```{r Seurat Visualization 1110, message = F, echo = F}
xx = celltypes$CellTypes
xx[xx == "Plasma.cells"] = "B"
xx[xx == "NonImmune"] = celltypes$CellStates[xx == "NonImmune"]
writeLines("td, th { padding : 6px } th { background-color : brown ; color : white; border : 1px solid white; } td { color : brown ; border : 1px solid brown }", con = "mystyle.css")
knitr::kable(table(True_labels, Signac = xx), format = "html")
```

Save results

```{r save results, message = F, eval = F}
saveRDS(synovium, file = "synovium_signac.rds")
saveRDS(celltypes, file = "synovium_signac_celltypes.rds")
```

## Session information

```{r sessioninfo, message = F, echo = F}
sessionInfo()
```
